<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright(c) 2022 TechSure Co., Ltd. All Rights Reserved.
  ~ 本内容仅限于深圳市赞悦科技有限公司内部传阅，禁止外泄以及用于其他的商业项目。
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="codedriver.module.report.dao.mapper.ReportDataSourceDataMapper">
    <select id="getDataSourceDataCount" parameterType="codedriver.framework.report.dto.ReportDataSourceDataVo"
            resultType="int">
        select count(1)
        from ${tableName}
    </select>

    <insert id="insertDataSourceData" parameterType="codedriver.framework.report.dto.ReportDataSourceDataVo">
        insert into ${tableName}
        (
        <foreach collection="fieldList" item="item">
            `${item.id}`,
            `${item.id}_hash`,
        </foreach>
        id, insert_time<if test="expireDay != null">, expire_time</if>)
        values
        (
        <foreach collection="fieldList" item="item">
            #{item.value},
            #{item.value,typeHandler=Md5Handler},
        </foreach>
        #{id},now(3)
        <if test="expireDay != null">, DATE_ADD(curdate(),INTERVAL #{expireDay} day)</if>
        ) ON DUPLICATE KEY
        UPDATE
        <foreach collection="fieldList" item="item">
            `${item.id}` = #{item.value},
            `${item.id}_hash` = #{item.value,typeHandler=Md5Handler},
        </foreach>
        insert_time = now(3)
        <choose>
            <when test="expireDay != null">, expire_time = DATE_ADD(curdate(),INTERVAL #{expireDay} day)</when>
            <otherwise>,expire_time = null</otherwise>
        </choose>
    </insert>

    <delete id="truncateTable" parameterType="codedriver.framework.report.dto.ReportDataSourceVo">
        truncate table ${tableName}
    </delete>
</mapper>
